--- 
title: "Pentesting File Transfer Protocol (FTP)"
author: ""
date: 2023-08-08T14:45:14+01:00
description: ""
draft: false
disableComments: false
categories: []
series: [] #Taxonomy to list "See Also" Section in Opengraph Templates
tags: []
slug: ""
summary: ""
---
FTP (File Transfer Protocol) is used to communicate and transfer files between computers. Typically FTP service runs on `unsecured TCP port 21` or `secured TCP port 990`. The client and server establish a control channel through `TCP port 21` and data channel via `TCP port 20`. Depending on the configuration, FTP may use only `TCP port 21` or both `TCP port 20` and `TCP port 21`. FTP has active and passive connection modes.  

In a non-firewalled client environment communication can happen in an active mode. The client connects from a random unprivileged port (N > 1024) to the FTP server's port 21. Then, the client starts listening on port (M > 1024) and sends the FTP command `PORT M` to the FTP server. The server will then initiate a connection back to the client's specified data port M from its local data port 20. See _FTP Active Connection Mode Communication_ traffic flow.    
```shell
# on terminal one
sudo tcpdump -Uni $INTERFACE tcp port 21 or port 990    # unbuffered FTP capture filter

# on terminal two
ftp -n    # activate the ftp client utility inhibiting auto-login
ftp> open $IP    # connect to the FTP server
ftp> user $USERNAME $PASSWORD    # submit the username and password
ftp> ls    # list the contents of the working directory
ftp> quit    # quit the connection
```  
![FTP Active Connection Mode](/images/ftp/00_ftp-active-connection.png "FTP Active Connection Mode Communication")

In a firewalled client environment a passive mode is used. The client initiates connection to the FTP server's port 21 from a random unprivileged port (N > 1024) and issue the FTP command `PASV`. The result of this is that the server then opens a random unprivileged port (P > 1024) and sends the FTP command `PORT P` back to the client. The client then initiates the connection from port (M > 1024) to port P on the server to transfer data. See _FTP Passive Connection Mode Communication_ traffic flow.  
```shell
# on terminal one
sudo tcpdump -Uni $INTERFACE tcp port 21 or port 990    # unbuffered FTP capture filter

# on terminal two
ftp -np    # activate the ftp client in passive mode inhibiting auto-login
ftp> open $IP    # connect to the FTP server
ftp> user $USERNAME $PASSWORD    # submit the username and password
ftp> ls    # list the contents of the working directory
ftp> quit    # quit the connection
```
![FTP Passive Connection Mode](/images/ftp//00_ftp-passive-connection.png "FTP Passive Connection Mode Communication")

It is important to note that while observing the traffic on the wire we may only see the control port traffic due to how the FTP server was configured.     

**Common FTP Server Application**
+ Unix systems
    - vsftpd (Very Secure FTP Daemon)
    - ProFTPD
    - Pure-FTPd
+ Windows systems
    - Core FTP Server
    - IIS (Internet Information Services)
    - FileZilla Server

**Common FTP Commands**  

| COMMAND | USAGE | DESCRIPTION |
|---|---|---|
| ABOR | ABOR | **abor**t a file transfer |
| CWD | CWD $FOLDERNAME | **c**hange **w**orking **d**irectory |
| DELE | DELE $FILENAME | **dele**te a remote file |
| HELP | HELP `command` | show commands supported/details |
| LIST | LIST $FOLDERNAME | **l**i**st** of remote directory |
| MKD | CWD $FOLDERNAME | **m**a**k**e a remote **d**irectory |
| PASS | PASS $PASSWORD | send **pass**word |
| PASV | PASV | send **pass**word |
| PORT | PORT _a1_,_a2_,_a3_,_a4_,_p1_,_p2_ | open a data **port** where address _a1_._a2_._a3_._a4_, port ((_p1_ x 256) + _p2_) |
| PWD | PWD | **p**rint **w**orking **d**irectory |
| QUIT | QUIT |  terminate the connection |
| RETR | RETR $FILENAME | **retr**ieve a remote file |
| RMD | RMD $FOLDERNAME | **r**e**m**ove a remote **d**irectory |
| RNFR/RNTO | RNFR $OLD_FILENAME RNTO $NEW_FILENAME | **r**e**n**ame a file |
| STOR | STOR $FILENAME | **stor**e a file on the remote host |
| TYPE | TYPE $DATATYPE | set transfer **type** |
| USER | USERNAME $USERNAME | send **user**name |

**Common Vulnerability**
- Path Traversal: [CWE-37](https://www.cvedetails.com/cwe-details/37/Path-Traversal-039-absolute-pathname-here-039-.html)
- Information Disclosure: [CWE-200](https://www.cvedetails.com/cwe-details/200/Information-Exposure.html) [CWE - 220](https://www.cvedetails.com/cwe-details/220/Sensitive-Data-Under-FTP-Root.html) [CWE-319](https://www.cvedetails.com/cwe-details/319/Cleartext-Transmission-of-Sensitive-Information.html)
- Improper Access Control: [CWE-284](https://www.cvedetails.com/cwe-details/284/Access-Control-Authorization-Issues.html)

**Known Attack Vectors**
- [CVE-2002-1345](https://www.cve.org/CVERecord?id=CVE-2002-1345)
- [CVE-2015-3306](https://www.cve.org/CVERecord?id=CVE-2015-3306) 
- [CVE-2019-12815](https://www.cve.org/CVERecord?id=CVE-2019-12815): 
    - [Improper Access Control Vulnerability in ProFTPD Disclosed - Tenable](https://www.tenable.com/blog/cve-2019-12815-improper-access-control-vulnerability-in-proftpd-disclosed)

**Security Best Practices**
- Deploy the FTPS secure implementation, preferably SFTP which runs via SSH protocol.
- Enable authentication with a strong password policy.
- Enable file access control policy.
- Disable application version fingerprint.
- Configure CIDR/IP range whitelist if necessary.

**Exploitation**  
Almost all FTP implementations do not have ability to execute a shell command directly but are great for information disclosure, file upload and exfiltration. An attacker's inclination when an FTP service is encountered can include:
- What valuable information they can find including hidden contents.
- Whether they can perform path traversal to reach other valuable contents.
- Whether they can upload a malicious file and execute it through another service.

```shell
'WORDLISTS
/usr/share/seclists/Passwords/Common-Credentials/10k-most-common.txt
/usr/share/seclists/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt
'
## SERVICE ENUMERATION ##
# with nmap
ls /usr/share/nmap/scripts/ftp*    # list nmap ftp scripts
'SNIP
/usr/share/nmap/scripts/ftp-anon.nse
/usr/share/nmap/scripts/ftp-bounce.nse
/usr/share/nmap/scripts/ftp-brute.nse
/usr/share/nmap/scripts/ftp-libopie.nse
/usr/share/nmap/scripts/ftp-proftpd-backdoor.nse
/usr/share/nmap/scripts/ftp-syst.nse
/usr/share/nmap/scripts/ftp-vsftpd-backdoor.nse
/usr/share/nmap/scripts/ftp-vuln-cve2010-4221.nse
'
nmap -p 21 -sV $IP   # show version
nmap -p 21 --script ftp-anon $IP    # identify anonymous login
nmap --script ftp-bounce -Pn -b $USERNAME:$PASSWORD@$IP:$PORT -p$TARGETPORTS $TARGETIP -oN nmap_internal_scan    # initiate internal scan

# with telnet 
telnet $IP $PORT     # show banner

# with nc
nc -n $IP 21    # show banner

# with openssl
openssl s_client -connect $IP:21 -starttls ftp    # show banner and certificate

# with metasploit
search scanner/ftp
use auxiliary/scanner/ftp/ftp_version    # show version
show options
setg rhosts $IP
run

use auxiliary/scanner/ftp/anonymous    # identify anonymous login
show options
run

## CREDENTIAL ENUMERATION ##
# with nmap
nmap --script ftp-brute -p 21 $IP --script-args brute.mode=creds,brute.credfile=$USERNAMEPASSWORDLIST --min-rate 10000  # reveal credentials - wordlist entries must be in the form USERNAME/PASSWORD

# with hydra
hydra -t 20 -c 1 -L $USERNAMELIST -P $PASSWORDLIST -s 21 ftp://$IP -V    # reveal credentials

# with medusa
medusa -t 2 -T 2 -U $USERNAMELIST -P $PASSWORDLIST -h $IP -n 21 -M ftp | grep "SUCCESS"

# with metasploit
use auxiliary/scanner/ftp/ftp_login
show options
set threads 30
set rhosts $IP
set userpass_file $USERNAMEPASSWORDLIST    # wordlist in the form USERNAME PASSWORD
run

## PATH ENUMERATION ##
# with curl
curl -s ftp://$USERNAME:$PASSWORD@$IP    # login and list home folder contents
curl -s --user "$USERNAME:$PASSWORD" ftp://$IP:$PORT/ --upload-file $LOCAL_FILENAME     # upload file
curl -s ftp://$USERNAME:$PASSWORD@$IP/ --quote "DELE $REMOTE_FILENAME"    # delete specified file using ftp command

# with wget
wget -r -m --no-passive -nH -P $FOLDERNAME ftp://$USERNAME:$PASSWORD@$IP:$PORT/    # download recursively

## HOST ENUMERATION/FOOTPRINTING ##
# with ftp
ftp -n <<RUN
open $IP
user $USERNAME $PASSWORD
put $LOCAL_FILENAME
RUN

# with lftp
lftp -u '$USERNAME,$PASSWORD' -p21 $IP -c 'ls -a'    # login and list all contents
lftp    # activate the prompt
?    # show help
set ftp:ssl-force yes    # enable ssl
set ssl:verify-certificate no    # do not verify certificate
connect $IP    # connect to the server
login $USERNAME $PASSWORD    # login
```  

**References**  
- https://phoenixnap.com/kb/linux-ftp
- https://www.cosmos.esa.int/documents/772136/977578/psa_activeVsPassiveFtp.pdf
- https://exploit-notes.hdks.org/exploit/network/protocol/ftp-pentesting/
- https://secybr.com/posts/ftp-pentesting-best-practices/
- https://book.hacktricks.xyz/pentesting/pentesting-ftp
- https://www.infosecmatter.com/nmap-nse-library/?nse=ftp-brute
- https://ss64.com/rawftp.html