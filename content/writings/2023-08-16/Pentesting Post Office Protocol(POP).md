--- 
title: "Pentesting Post Office Protocol(POP)"
author: ""
date: 2023-08-16T19:53:39+01:00
description: ""
draft: false
disableComments: false
categories: []
series: [] #Taxonomy to list "See Also" Section in Opengraph Templates
tags: []
slug: ""
summary: ""
---
Post Office Protocol (POP) is a mail protocol for retrieving mail from a remote mail server to a local mail client. Usually, once the client downloads the received mail from the `Inbox` folder, the mail is removed from the server. This results in the mail not been able to be accessed across multiple devices.

The first version of  POP, specified in RFC 918 was published in 1984 and was immediately followed by POP2 in 1985 before POP3 was released in 1988 and underwent several revisions until 1996.Â By default POP runs on `unsecured TCP port 110` or `secured TCP 995` if SSL/TLS enabled. It works in tandem with Simple Mail Transfer Protocol (SMTP) for end-to-end email communication, where POP pulls messages and SMTP pushes them to the server.

![SMTP/POP/IMAP Communication](/images/smtp/00_smtp-pop-imap-communication.png "SMTP/POP/IMAP Communication")  

To Observe the POP communication on the wire, see _POP Communication_ traffic flow.  
```shell
# on terminal one
sudo tcpdump -Uni $INTERFACE tcp port 110 or 995    # unbuffered FTP capture filter

# on terminal two
nc --ssl $IP $PORT    # open a connection to server
user $USERNAME    # submit username
pass $PASSWORD    # submit password for username
list    # list mails in the inbox
quit    # quit pop session connection
```
![POP Traffic](/images/pop/00_pop3s-traffic.png "POP3s Traffic")

**Common Server Application**
+ Unix systems
    - Dovecot
    - Postfix
    - Exim
+ Windows systems
    - MailEnable
    - Microsoft Exchange Server
    - Zimbra
**Common Commands**

| COMMAND | USAGE | DESCRIPTION |
|---|---|---|
| CAPA | CAPA | list supported **capa**bilities |
| DELE | DELE n | **dele**te specified message number index n |
| LIST | LIST | **list** all messages in inbox |
| NOOP | NOOP | ping the server |
| PASS | PASS $PASSWORD | submit **pass**word for username |
| QUIT | QUIT | **quit** connection session (expunges messages if no RSET) |
| RETR | RETR n | **retr**ieve content of specified message number index n |
| RSET | RSET | unmark messages queued for deletion |
| STAT | STAT | list messages and total mailbox size |
| TOP | TOP n l | show l number of lines of specified message number index n |
| USER | USER $USERNAME | login with specified username |

**Common Vulnerability**
- Improper Validation of Input: [CWE-1285](https://www.cvedetails.com/cwe-details/1285)
- Exposure of Sensitive Information: [CWE-200](https://www.cvedetails.com/cwe-details/200)  

**Security Best Practices**
- Deploy a TLS POP3 for encrypted communication.
- Enable strong password policies and two-factor authentication for user accounts.

**Exploitation**  
Although not prevalent as its counterpart IMAP an attacker can still exploit this service. One caveat to keep in mind though is that depending on the configuration of the server and the attacker's goal they may have a hard time repeating a particular procedure. For example they have just once chance to exfilterate a confidential mail and it has to be resident in the inbox. One primary inclination is:
- Whether they are able to retrieve sensitive information.

```shell
## SERVICE ENUMERATION ## 
# with nmap
ls /usr/share/nmap/scripts/pop*    # list nmap pop3 scripts
'SNIP
/usr/share/nmap/scripts/pop3-brute.nse
/usr/share/nmap/scripts/pop3-capabilities.nse
/usr/share/nmap/scripts/pop3-ntlm-info.nse
'
nmap -p 110,995 -sV $IP   # run a version scan 
nmap -p 110,995 --script pop3-capabilities $IP   # show capabilities

# with telnet
telnet $IP 110    # show banner

# with metasploit
search scanner name:pop3
use auxiliary/scanner/pop3/pop3_version
set rhosts $IP
exploit 

## CREDENTIAL ENUMERATION ##
# with hydra
hydra -t 10 -L $USERNAMELIST -P $PASSWORDLIST -s 110 $IP pop3 -V    # find credentials
hydra -S -t 20 -l $USERNAME -P $PASSWORDLIST -s 995 $IP pop3 -V    # find credentials via SSL/TLS

## PATH ENUMERATION ##

## HOST ENUMERATION/FOOTPRINTING ##
# with nc
nc -nv --ssl $IP 995
user $USERNAME
pass $PASSWORD
list
retr $MESSAGE_INDEX
quit

# with openssl
openssl s_client -connect $IP:110 -starttls pop3 -crlf    # upgrade connection and fingerprint
openssl s_client -connect $IP:995 -crlf -quiet    # fingerprint via SSL/TLS
```

**References**  
- https://www.2brightsparks.com/resources/articles/understanding-post-office-protocol-pop3.html
- https://www.atmail.com/blog/pop-101-manual-pop-sessions/
- https://secybr.com/posts/pop3-pentesting-best-practices/
- https://book.hacktricks.xyz/network-services-pentesting/pentesting-pop