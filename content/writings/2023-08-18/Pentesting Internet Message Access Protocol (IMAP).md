--- 
title: "Pentesting Internet Message Access Protocol (IMAP)"
author: ""
date: 2023-08-18T00:37:43+01:00
description: ""
draft: false
disableComments: false
categories: []
series: [] #Taxonomy to list "See Also" Section in Opengraph Templates
tags: []
slug: ""
summary: ""
---
Internet Message Access Protocol (IMAP) is a mail protocol that allows multiple clients to synchronously retrieve emails from a mail server. Designed by Mark Reed Crispin in 1986, it metamorphosed through IMAP2, IMAP3, and currently IMAP4 introduced in 1994. Unlike its counterpart, POP3, IMAP effectively solved the problem of a one off access to mails with the features to sync mails across devices, and manage the mailboxes.  

![SMTP/POP/IMAP Communication](/images/smtp/00_smtp-pop-imap-communication.png "SMTP/POP/IMAP Communication")  

IMAP runs on `unsecured TCP port 143` or `secured TCP port 993` . On the wire, here is how an _IMAP Communication_ traffic looks.  

```shell
# on terminal one
sudo tcpdump -Uni $INTERFACE tcp port 143 or 993    # unbuffered FTP capture filter

# on terminal two
openssl s_client -connect $IP:143 -starttls imap -crlf -quiet    # open and upgrade connection to server
c login $USERNAME $PASSWORD    # login
c list "" "*"    # list mailboxes
c logout    # terminate the session
```  

![IMAP Traffic](/images/imap/00_imap-traffic.png "IMAPs Traffic")

**Common Server Application**
+ Unix systems
    - Dovecot
    - Courier IMAP
    - Cyrus IMAP
    - Citadel
+ Windows systems
    - MailEnable
    - Kerio Connect
    - Microsoft Exchange Server
    - Zimbra  

**Common Commands**

| COMMAND | USAGE | DESCRIPTION |
|---|---|---|
| CAPABILITY | CAPABILITY | list supported commands |
| CLOSE | CLOSE | **close** current mailbox operated |
| CREATE | CREATE $MAILBOXNAME | **create** a new mailbox with the specified name |
| DELETE | DELETE $MAILBOXNAME | move specified mailbox to trash |
| EXAMINE | EXAMINE $MAILBOX_NAME | same as `SELECT` but in read-only mode |
| LIST | LIST $REFERENCE $MAILBOX | **list** specified mailbox, use empty string as reference and glob for listing all mailbox |
| LOGIN | LOGIN $USERNAME $PASSWORD | authenticate with the server |
| LOGOUT | LOGOUT | exit an IMAP session |
| LSUB | LSUB $REFERENCE $MAILBOX | **list** mailboxes subscribed to |
| NOOP | NOOP | ping server for liveliness |
| RENAME | RENAME $OLDNAME $NEWNAME | **rename** a mailbox |
| SELECT | SELECT $MAILBOXNAME | **select** a mailbox for subsquent operations |
| UNSELECT | UNSELECT $MAILBOXNAME | unmark previously selected mailbox |

**Common Vulnerability**
- Improper Input Validation: [CWE-20](https://www.cvedetails.com/cwe-details/20)
- Sensitive Information in Error Message: [CWE-209](https://www.cvedetails.com/cwe-details/209)
- Resource Exhaustion: [CWE-400](https://www.cvedetails.com/cwe-details/400)  

**Security Best Practices**
- Deploy a TLS IMAP for encrypted communication.
- Enable strong password policies and two-factor authentication for user accounts.  

**Exploitation**  
Encountering an IMAP service also leaves the hunch to hunt for sensitive credentials. Some library like the `php-imap` has facilitated remote code execution in the past. Nevertheless, an attacker's inclination would be:
- Whether they are able to retrieve sensitive information.

```shell
## SERVICE ENUMERATION ## 
# with nmap
ls /usr/share/nmap/scripts/imap*    # list nmap imap scripts
'SNIP
/usr/share/nmap/scripts/imap-brute.nse
/usr/share/nmap/scripts/imap-capabilities.nse
/usr/share/nmap/scripts/imap-ntlm-info.nse
'
nmap -p 143,993 -sV $IP   # run a version scan 
nmap -p 143,993 --script imap-capabilities $IP   # show capabilities 

# with telnet
telnet $IP $PORT    # show banner

# with metasploit
msfconsole -q
search scanner name:imap
use auxiliary/scanner/imap/imap_version
set rhosts $IP
exploit 

## CREDENTIAL ENUMERATION ##
# with nmap
nmap -p 143,993 --script imap-ntlm-info $IP   # show the NLTM hash

# with hydra
hydra -t 10 -L $USERNAMELIST -P $PASSWORDLIST -s 143 $IP imap -V    # find credentials
hydra -S -t 20 -l $USERNAME -P $PASSWORDLIST -s 993 $IP imaps -V    # find credentials via SSL

# with medusa
medusa -t 2 -u $USERNAME -P $PASSWORDLIST -e s -n 993 -s -M imap -h $IP -O $OUTPUT_FOLDER    # find credentials via SSL/TLS (-s: use seucre port)

## PATH ENUMERATION ##
# with curl
curl -sk --user $USERNAME:$PASSWORD 'imaps://$IP'   # list all mailboxes
curl -sk --user $USERNAME:$PASSWORD 'imaps://$IP/$MAILBOX?ALL' # list the mailbox message index
curl -sk --user $USERNAME:$PASSWORD 'imaps://$IP/$MAILBOX;MAILINDEX=$MAILINDEX' # show content of specified mail index

## HOST ENUMERATION/FOOTPRINTING ##
# with nc
nc -n --ssl $IP 993  # connect to server via SSL/TLS

# with openssl
openssl s_client -connect $IP:143 -starttls imap -crlf -quiet  
openssl s_client -connect $IP:993 -crlf -quiet
c login $USERNAME $PASSWORD    # login
c list "" "*"    # list mailboxes
c select $MAILBOX    # case-sensitive mailbox name
c search all    # list all mail indexes
c fetch 1 body[]    # read content of specified mail index
c close    # close the selected mailbox
c logout    # terminate the session
```

**References**  
- https://en.wikipedia.org/wiki/Internet_Message_Access_Protocol
- https://www.atmail.com/blog/imap-commands/
- https://linuxhint.com/imap-command/
- https://book.hacktricks.xyz/network-services-pentesting/pentesting-imap
- https://secybr.com/posts/imap-pentesting-best-practices/